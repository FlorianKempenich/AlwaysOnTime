<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Always On Time</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"
          integrity="sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm" crossorigin="anonymous">
    <style>
        * {
            box-sizing: border-box;
        }
        .timers {
            position: relative;
        }
        .timer {
            margin: 30px;
            width: auto;
        }
        @media (min-width: 500px) {
            .timer {
                margin: 30px;
                width: 290px;
            }
        }


        .container {
            margin-top: 100px;
        }

        .columns:first-child {
            margin-bottom: 130px;
        }

        html {
            background-color: #fff9ee;
        }
    </style>
</head>
<body>
<div class="container timers">
    {% for e in events %}
        <div class="columns">
            <div class="card timer">
                <div class="card-content">
                    <div class="media">
                        <div class="media-content">
                            <div class="summary">{{ e.summary }}</div>
                        </div>
                    </div>
                    <div class="content">
                        <p class="time is-centered is-size-2" data-start="{{ e.start|date:"r" }}"></p>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
</div>
<hr>
<ul>
    <li><a href="/sandbox">Run Sandbox</a></li>
    <li><a href="/refresh_events_in_db">Refresh events in DB</a></li>
    <li><a href="/revoke">Revoke token and Logout</a></li>
    <li><a href="/accounts/logout">Logout</a></li>
    <li><a href="/accounts/login/">Login</a></li>
    <li><a href="/admin/">Admin</a></li>
</ul>

<div class="debug"></div>
<script>
    const DEBUG_MODE = false;
    const timerTimeDivs = document.querySelectorAll('.timer .time')

    const formatTimer = timer => {
        const floor_pos = n => n <= 0 ? 0 : Math.floor(n)
        const days = floor_pos(timer / 1000 / 60 / 60 / 24)
        const hours = floor_pos((timer / 1000 / 60 / 60) - days * 24)
        const minutes = floor_pos((timer / 1000 / 60) - days * 24 * 60 - hours * 60)
        const seconds = floor_pos((timer / 1000) - days * 24 * 60 * 60 - hours * 60 * 60 - minutes * 60)

        if (DEBUG_MODE) {
            return `${days}d ${hours}h ${minutes}m ${seconds}s`
        }
        return hours ?
            `${hours}h ${minutes}m` :
            `${minutes}m`
    }
    const refreshTimers = () => {
        const now = Date.now()

        for (const timeDiv of timerTimeDivs) {
            const eventStart = Date.parse(timeDiv.dataset.start);
            const timer = eventStart - now
            timeDiv.textContent = formatTimer(timer)
        }

        setTimeout(refreshTimers, 1000)
    }
    refreshTimers()


    /*
    * DEBUG - Reload every 2 sec
    */
    const debugDiv = document.querySelector('.debug')
    let countDown = 2;
    const debug = () => {
        if (!countDown) {
            location.reload();
        }
        debugDiv.textContent = `Reloading page in ${countDown}s`
        countDown--
        setTimeout(debug, 1000)
    }
    if (DEBUG_MODE) debug()
</script>
</body>
</html>